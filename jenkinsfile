pipeline {
    agent any

    environment {
        GITHUB_REPO = "https://github.com/patthechosen/Jenkins.git"
        DOCKERHUB_REPO = "patthechosen/pat_jenkins_pipeline"
        DOCKERHUB_CREDS = credentials('DockerhubCreds-id')
    }

    stages {
        stage('Source') {
            steps {
                echo 'Checking out GitHub repository'
                git branch: 'main', credentialsId: 'GithubCredsok', url: "${GITHUB_REPO}"
                sh 'ls -l'
            }
        }

        stage('Build') {
            steps {
                echo "Building the Docker image using the Dockerfile from GitHub"
                sh "docker build -t ${DOCKERHUB_REPO}:v${BUILD_NUMBER} -f Dockerfile ."
                sh "docker images"
            }
        }

        stage('Docker login') {
            steps {
                echo "Logging into Docker Hub"
                sh "docker login -u ${env.DOCKERHUB_CREDS_USR} -p ${env.DOCKERHUB_CREDS_PSW}"
            }
        }

        stage('Push Docker Image') {
            steps {
                echo "Pushing Docker image v${BUILD_NUMBER} to Docker Hub"
                sh "docker push ${DOCKERHUB_REPO}:v${BUILD_NUMBER}"
            }
        }

        stage('Run Apache Container') {
            steps {
                echo "Running Apache container with GitHub index.html"
                sh "docker run -d --name apache_container -p 80:80 ${DOCKERHUB_REPO}:v${BUILD_NUMBER}"
                sh "docker ps | grep apache_container"
            }
        }
    }
}